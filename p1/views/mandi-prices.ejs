<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandi Prices</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .search-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .search-row {
            margin-bottom: 15px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .search-btn {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Latest Mandi Prices J&K</h1>
        
        <!-- Search Section -->
        <div class="search-container">
            <form id="searchForm" action="/mandi-prices" method="get">
                <div class="row search-row">
                    <div class="col-md-4">
                        <label for="commodity" class="form-label">Commodity</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="commodity" name="commodity" 
                                   value="<%= filters.commodity || '' %>" placeholder="Search by commodity">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchByField('commodity')">
                                Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="state" class="form-label">State</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="state" name="state" 
                                   value="<%= filters.state || '' %>" placeholder="Search by state">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchByField('state')">
                                Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="district" class="form-label">District</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="district" name="district" 
                                   value="<%= filters.district || '' %>" placeholder="Search by district">
                            <button class="btn btn-outline-secondary" type="button" onclick="searchByField('district')">
                                Search
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary search-btn">Search All</button>
                        <a href="/mandi-prices" class="btn btn-outline-secondary search-btn">Reset Filters</a>
                    </div>
                </div>
            </form>
        </div>

        <div class="mb-3">
            <span class="badge bg-primary">Last Updated: <%= new Date().toLocaleString('en-IN', {timeZone: 'Asia/Kolkata'}) %></span>
            <span class="badge bg-success ms-2">Showing <%= prices.length %> records</span>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Commodity</th>
                        <th>State</th>
                        <th>District</th>
                        <th>Mandi</th>
                        <th>Price Per KG (₹)</th>
                        <th>Arrival Date</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (prices.length === 0) { %>
                        <tr>
                            <td colspan="6" class="text-center">No records found matching your search criteria</td>
                        </tr>
                    <% } %>
                    
                    <% prices.forEach(price => { %>
                        <tr>
                            <td><%= price.Commodity %></td>
                            <td><%= price.State %></td>
                            <td><%= price.District %></td>
                            <td><%= price.Mandi %></td>
                            <td>
                                <% 
                                // Fixed price calculation with proper error handling
                                let priceValue = 0;
                                try {
                                    if (price.ModalPrice && typeof price.ModalPrice === 'string') {
                                        priceValue = Number(price.ModalPrice.replace(/[^0-9.]/g, '')) / 100;
                                    } else if (price.ModalPrice) {
                                        priceValue = Number(price.ModalPrice) / 100;
                                    }
                                } catch (e) {
                                    console.error('Error parsing price:', e);
                                }
                                %>
                                ₹<%= priceValue.toFixed(2) %>
                            </td>
                            <td><%= price.ArrivalDate.toLocaleDateString('en-IN') %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function searchByField(field) {
            const form = document.getElementById('searchForm');
            const input = document.getElementById(field);
            
            // Clear other search fields
            if (field !== 'commodity') document.getElementById('commodity').value = '';
            if (field !== 'state') document.getElementById('state').value = '';
            if (field !== 'district') document.getElementById('district').value = '';
            
            // Only submit if there's a value in the field
            if (input.value.trim()) {
                form.submit();
            } else {
                // If field is empty, reset all filters
                window.location.href = '/mandi-prices';
            }
        }
    </script>
</body>
</html>